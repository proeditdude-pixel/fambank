<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F4F8">
    <title>FamBank</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- 1. PREMIUM THEME VARIABLES --- */
        :root {
            --primary: #4361EE;
            --primary-dark: #3046C4;
            --accent: #FFB703;
            --success: #06D6A0;
            --error: #EF476F;
            
            --bg-body: #F2F4F8;
            --bg-card: #FFFFFF;
            
            --text-main: #1D2435;
            --text-muted: #8D99AE;
            
            --radius-xl: 32px;
            --radius-lg: 24px;
            --radius-md: 16px;
            
            /* Soft "Apple-style" shadows */
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.03);
            --shadow-md: 0 12px 30px rgba(67, 97, 238, 0.12), 0 4px 8px rgba(0,0,0,0.02);
            --shadow-float: 0 20px 50px rgba(67, 97, 238, 0.2);

            /* Spring Animation Curve */
            --bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100dvh; 
            width: 100vw;
            display: flex;
            overflow: hidden; 
            position: fixed;
        }

        /* --- 2. UI COMPONENTS --- */
        
        input, select {
            width: 100%; padding: 20px; font-size: 16px; font-family: 'Outfit', sans-serif;
            border: 2px solid transparent; background: #F8F9FC;
            border-radius: var(--radius-lg); margin-bottom: 15px;
            color: var(--text-main); font-weight: 600; 
            transition: all 0.3s var(--bounce);
        }
        input:focus { 
            background: white; 
            border-color: var(--primary); 
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.15); 
            transform: translateY(-2px);
        }

        .btn {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border: none; border-radius: var(--radius-lg);
            font-size: 16px; font-weight: 800; cursor: pointer; font-family: 'Outfit', sans-serif;
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
            transition: transform 0.2s var(--bounce), box-shadow 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn:active { transform: scale(0.95); box-shadow: 0 2px 10px rgba(67, 97, 238, 0.2); }
        
        .btn.secondary { 
            background: white; color: var(--text-main); 
            box-shadow: var(--shadow-sm); border: 1px solid #EEF2F6; 
        }
        .btn.danger { 
            background: var(--error); box-shadow: 0 8px 20px rgba(239, 71, 111, 0.3); 
        }
        .btn.small { padding: 12px 24px; width: auto; font-size: 14px; border-radius: var(--radius-md); }

        .toast-msg {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: white; color: var(--text-main); padding: 15px 30px;
            border-radius: 50px; font-weight: 700; font-size: 14px;
            box-shadow: var(--shadow-float); z-index: 11000;
            opacity: 0; transition: all 0.5s var(--bounce);
            display: flex; align-items: center; gap: 10px;
        }
        .toast-msg.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* --- 3. LAYOUT & ANIMATIONS --- */
        .main-content {
            flex: 1; position: relative; 
            overflow-y: auto; -webkit-overflow-scrolling: touch; 
            height: 100%; padding: 20px; padding-bottom: 120px;
        }

        .view {
            display: none; max-width: 600px; margin: 0 auto;
            opacity: 0; transform: scale(0.95) translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s var(--bounce);
        }
        .view.active { 
            display: block; opacity: 1; transform: scale(1) translateY(0); 
        }

        /* --- 4. NAVIGATION --- */
        .sidebar {
            width: 280px; background: white;
            display: none; flex-direction: column; padding: 40px 30px;
            box-shadow: var(--shadow-sm); z-index: 50;
        }
        .nav-item {
            display: flex; align-items: center; padding: 18px 20px;
            margin-bottom: 10px; border-radius: var(--radius-lg);
            color: var(--text-muted); font-weight: 700; cursor: pointer; transition: 0.3s var(--bounce);
        }
        .nav-item:hover { background: #F8F9FC; color: var(--primary); transform: translateX(5px); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: var(--shadow-md); }

        .mobile-nav {
            position: fixed; bottom: 30px; left: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            height: 80px; border-radius: 40px;
            display: none; justify-content: space-evenly; align-items: center;
            box-shadow: var(--shadow-float); z-index: 100; border: 1px solid rgba(255,255,255,0.5);
        }
        .mobile-tab { 
            color: #C5CEE0; width: 55px; height: 55px; 
            display: flex; justify-content: center; align-items: center;
            border-radius: 50%; transition: all 0.4s var(--bounce); font-size: 24px;
        }
        .mobile-tab.active { 
            color: white; background: var(--primary); 
            transform: translateY(-15px) scale(1.1); 
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.4); 
        }

        /* --- 5. PROFILE --- */
        .profile-card {
            background: white; border-radius: var(--radius-xl); 
            box-shadow: var(--shadow-md); text-align: center;
            padding-bottom: 40px; position: relative;
            margin-top: 20px; overflow: visible;
        }
        .prof-banner {
            height: 180px; width: 100%;
            background-size: cover; background-position: center;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            position: relative;
        }
        .prof-pfp-container {
            width: 120px; height: 120px;
            background: white; border-radius: 50%;
            position: absolute; 
            bottom: -60px; 
            left: 50%; 
            transform: translateX(-50%);
            display: flex; justify-content: center; align-items: center;
            padding: 5px; 
            z-index: 10;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .prof-pfp {
            width: 100%; height: 100%; border-radius: 50%;
            background: #F8F9FC; font-size: 50px;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; 
        }
        .prof-pfp img { width: 100%; height: 100%; object-fit: cover; }
        
        .prof-info-area { margin-top: 70px; padding: 0 25px; }
        
        /* Badges */
        .badge-grid {
            display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 15px;
            min-height: 40px;
        }
        .badge-icon {
            width: 36px; height: 36px; object-fit: contain;
            transition: transform 0.3s var(--bounce); cursor: help;
        }
        .badge-icon:hover { transform: scale(1.2) rotate(10deg); }

        /* --- 6. ADMIN PANEL --- */
        .admin-section {
            background: white; border-radius: var(--radius-lg); padding: 25px;
            margin-bottom: 20px; box-shadow: var(--shadow-sm);
        }
        .admin-badge-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px; margin-top: 15px;
        }
        /* REVERTED: Removed grayscale so they look like the old icons */
        .admin-badge-item {
            aspect-ratio: 1; border-radius: 16px; background: #F8F9FC;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            border: 2px solid transparent; opacity: 0.5;
            transition: all 0.3s var(--bounce); position: relative;
        }
        .admin-badge-item img { width: 32px; height: 32px; object-fit: contain; }
        
        .admin-badge-item.active {
            opacity: 1; 
            background: #E8FBF4; border-color: var(--success);
            box-shadow: 0 8px 20px rgba(6, 214, 160, 0.2);
            transform: translateY(-3px);
        }
        .admin-badge-item.active::after {
            content: '‚úì'; position: absolute; top: -6px; right: -6px;
            background: var(--success); color: white; width: 20px; height: 20px;
            border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
        }

        .list-item {
            background: white; padding: 20px; border-radius: var(--radius-lg);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow-sm); margin-bottom: 15px; cursor: pointer;
            transition: transform 0.2s var(--bounce);
        }
        .list-item:active { transform: scale(0.97); }

        /* --- 7. MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(29, 36, 53, 0.6); backdrop-filter: blur(5px); z-index: 5000;
            display: none; justify-content: center; align-items: center; 
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }
        
        .modal-card {
            background: white; width: 90%; max-width: 480px;
            border-radius: var(--radius-xl); padding: 35px;
            box-shadow: var(--shadow-float);
            transform: scale(0.8) translateY(20px); transition: all 0.4s var(--bounce);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.show .modal-card { transform: scale(1) translateY(0); }

        .edit-fab {
            background: white; width: 44px; height: 44px; border-radius: 50%;
            position: absolute; top: 20px; right: 20px;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 18px; z-index: 20;
            transition: 0.2s var(--bounce);
        }
        .edit-fab:active { transform: scale(0.8); }

        .file-upload-btn {
            background: #F8F9FC; border: 2px dashed #DCE4EF;
            color: var(--text-muted); padding: 25px; border-radius: var(--radius-lg);
            text-align: center; font-weight: 700; cursor: pointer;
            margin-bottom: 15px; position: relative; transition: 0.3s;
        }
        .file-upload-btn:hover { border-color: var(--primary); color: var(--primary); background: #EEF2FF; }
        .file-upload-btn input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .preview-box { width: 100%; height: 120px; background: #eee; border-radius: var(--radius-lg); margin-bottom: 15px; display: none; background-size: cover; background-position: center; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }

        @media(min-width: 768px) {
            .mobile-nav { display: none; }
            .sidebar { display: flex; }
        }
        @media(max-width: 767px) {
            .mobile-nav { display: flex; }
            .sidebar { display: none; }
        }
        
        h1 { margin: 0 0 10px 0; font-weight: 800; letter-spacing: -0.5px; }
        h2 { margin: 0 0 15px 0; font-weight: 700; letter-spacing: -0.5px; }
        p { margin: 0 0 20px 0; color: var(--text-muted); line-height: 1.5; }

    </style>
</head>
<body>

    <div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-body); z-index:10000; display:flex; justify-content:center; align-items:center;">
        <div style="font-size:50px; animation: breathe 2s infinite ease-in-out;">üè¶</div>
    </div>
    <style>@keyframes breathe { 0%,100% { transform: scale(1); opacity:0.8; } 50% { transform: scale(1.2); opacity:1; } }</style>

    <div id="toast" class="toast-msg"></div>

    <div class="sidebar" id="desktop-sidebar">
        <div style="font-size:26px; font-weight:900; color:var(--primary); margin-bottom:50px; display:flex; align-items:center; gap:10px;">
            <span>üè¶</span> FamBank
        </div>
        <div class="nav-item active" onclick="switchNav('home-view')">üè† Home</div>
        <div class="nav-item" onclick="switchNav('family-view')">üë®‚Äçüë©‚Äçüëß Family</div>
        <div class="nav-item" onclick="switchNav('store-view')">üõçÔ∏è Store</div>
        <div class="nav-item" onclick="switchNav('profile-view')">üë§ Profile</div>
        <div style="flex:1;"></div>
        <div class="nav-item" style="color:var(--error);" onclick="logout()">üö™ Log Out</div>
    </div>

    <div class="main-content">
        
        <div id="auth-view" class="view" style="display:flex; flex-direction:column; justify-content:center; height:100%; max-width:400px; margin:auto;">
            <div style="text-align:center; margin-bottom:40px;">
                <div style="font-size:60px; margin-bottom:20px;">üëã</div>
                <h1 style="font-size:32px;">Welcome Back</h1>
                <p>Manage your family rewards easily.</p>
            </div>
            
            <button class="btn" style="background:white; color:#333; margin-bottom:20px;" onclick="loginGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="margin-right:10px;"> Continue with Google
            </button>
            
            <div style="display:flex; align-items:center; margin:20px 0; color:var(--text-muted); font-size:12px; font-weight:700;">
                <div style="flex:1; height:1px; background:#DCE4EF;"></div>
                <span style="padding:0 15px;">OR EMAIL</span>
                <div style="flex:1; height:1px; background:#DCE4EF;"></div>
            </div>
            
            <input type="email" id="email-in" placeholder="Email Address">
            <input type="password" id="pass-in" placeholder="Password">
            
            <button class="btn" onclick="loginEmail()">Log In</button>
            <button class="btn secondary" style="margin-top:15px; background:transparent; border:none; box-shadow:none;" onclick="signupEmail()">Create an account</button>
        </div>

        <div id="setup-view" class="view" style="padding-top:100px; text-align:center;">
            <h1>Setup Profile</h1>
            <p>What should we call you?</p>
            <input type="text" id="setup-name" placeholder="Display Name (e.g. Dad)">
            <button class="btn" onclick="finalizeSetup()">Get Started</button>
        </div>

        <div id="home-view" class="view">
            <h1 style="margin-top:20px;">Dashboard</h1>
            
            <div style="background: linear-gradient(120deg, var(--primary), #6C5CE7); color: white; padding: 40px; border-radius: var(--radius-xl); box-shadow: var(--shadow-md); position:relative; overflow:hidden; margin-top:20px;">
                <div style="position:absolute; top:-20px; right:-20px; width:100px; height:100px; background:rgba(255,255,255,0.1); border-radius:50%;"></div>
                <p style="margin:0; text-transform:uppercase; font-size:12px; font-weight:800; letter-spacing:1px; opacity:0.8;">Current Balance</p>
                <h1 style="font-size:64px; margin: 10px 0; font-weight:800;" id="coin-count">0</h1>
                <div style="font-weight:700; opacity:0.9;">Tokens Available</div>
            </div>

            <h2 style="margin-top:40px;">Your Tasks</h2>
            <div id="task-list">
                <div style="text-align:center; padding:40px; color:var(--text-muted);">No active tasks</div>
            </div>
        </div>

        <div id="family-view" class="view">
            <h1 style="margin-top:20px;">Family Group</h1>
            
            <div id="fam-forms" style="background:white; padding:30px; border-radius:var(--radius-xl); box-shadow:var(--shadow-sm); margin-top:20px;">
                <h2>Create or Join</h2>
                <input type="text" id="fam-name-in" placeholder="New Family Name">
                <button class="btn" onclick="createFamily()">Create Family</button>
                <div style="text-align:center; margin:20px; font-weight:800; color:var(--text-muted); font-size:12px;">OR JOIN EXISTING</div>
                <input type="text" id="fam-code-in" placeholder="Enter Invite Code">
                <button class="btn secondary" onclick="joinFamily()">Join with Code</button>
            </div>

            <div id="fam-display" style="display:none; text-align:center; margin-top:40px;">
                <div style="background:white; padding:40px; border-radius:var(--radius-xl); box-shadow:var(--shadow-float);">
                    <div style="font-size:50px; margin-bottom:10px;">üè†</div>
                    <h2 id="d-fam-name" style="font-size:28px;">My Family</h2>
                    <div style="margin-top:30px; background:#FFF8E1; padding:20px; border-radius:var(--radius-lg); display:inline-block; border:2px dashed #FFB142;">
                        <small style="color:#FFB142; font-weight:800;">INVITE CODE</small>
                        <div style="font-size:32px; font-weight:900; letter-spacing:4px; color:#2C3A59;" id="d-fam-code"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="store-view" class="view">
            <h1 style="margin-top:20px;">Rewards Store</h1>
            <div style="margin-top:20px;">
                <div class="list-item">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="font-size:30px;">üç¶</div>
                        <div><div style="font-weight:bold;">Ice Cream</div><div style="font-size:12px; color:var(--text-muted);">Delicious treat</div></div>
                    </div>
                    <button class="btn small" style="background:var(--bg-body); color:var(--primary);">100 T</button>
                </div>
            </div>
        </div>

        <div id="profile-view" class="view">
            <h1 style="margin-top:20px; margin-bottom:10px;">My Profile</h1>
            
            <div class="profile-card">
                <div class="prof-banner" id="p-banner">
                    <div class="edit-fab" onclick="openEditProfile()">‚úé</div>
                </div>
                <div class="prof-pfp-container">
                    <div class="prof-pfp" id="p-pfp">üôÇ</div>
                </div>
                <div class="prof-info-area">
                    <h2 style="margin:0; font-size:28px;" id="p-name">Loading...</h2>
                    <div style="color:var(--text-muted); font-size:14px; font-weight:600; margin-top:5px;" id="p-email">...</div>
                    <div class="badge-grid" id="p-badges"></div>
                </div>
            </div>

            <button id="admin-btn" class="btn" style="background:#2C3A59; margin-top:25px; display:none; box-shadow:0 10px 20px rgba(44, 58, 89, 0.3);" onclick="openAdmin()">
                <span>üëë</span> Admin Panel
            </button>
        </div>

        <div id="admin-view" class="view">
            <h1 style="margin-top:20px;">Admin Panel</h1>
            <p>Full control over users and economy.</p>
            <div id="admin-user-list" style="margin-top:30px;"></div>
            <button class="btn secondary" style="margin-top:20px;" onclick="switchNav('profile-view')">Back to Profile</button>
        </div>

    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-card">
            <h2>Edit Profile</h2>
            
            <p style="font-size:11px; font-weight:800; color:var(--text-muted); margin-bottom:5px;">DISPLAY NAME</p>
            <input type="text" id="edit-name-in">
            
            <p style="font-size:11px; font-weight:800; color:var(--text-muted); margin-bottom:5px;">PROFILE PICTURE</p>
            <div class="file-upload-btn">
                <span>üìÅ Upload Image</span>
                <input type="file" id="file-pfp" accept="image/*" onchange="previewFile('file-pfp','prev-pfp')">
            </div>
            <div id="prev-pfp" class="preview-box"></div>

            <p style="font-size:11px; font-weight:800; color:var(--text-muted); margin-bottom:5px;">BANNER IMAGE</p>
            <div class="file-upload-btn">
                <span>üñºÔ∏è Upload Banner</span>
                <input type="file" id="file-ban" accept="image/*" onchange="previewFile('file-ban','prev-ban')">
            </div>
            <div id="prev-ban" class="preview-box"></div>

            <button class="btn" onclick="saveProfile()">Save Changes</button>
            <button class="btn secondary" style="margin-top:10px;" onclick="closeModal('edit-modal')">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="admin-modal">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="adm-title" style="margin:0;">User</h2>
                <div style="background:#F2F4F8; padding:5px 10px; border-radius:10px; font-size:12px; font-weight:bold;">EDITING</div>
            </div>
            
            <div class="admin-section">
                <p style="font-size:11px; font-weight:800; color:var(--text-muted); margin-bottom:8px;">DISPLAY NAME</p>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="adm-name-in" style="margin:0;">
                    <button class="btn small" onclick="adminSaveName()">Save</button>
                </div>
            </div>

            <div class="admin-section">
                <p style="font-size:11px; font-weight:800; color:var(--text-muted); margin-bottom:8px;">TOKENS</p>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="adm-coin-in" style="margin:0;">
                    <button class="btn small" onclick="adminSaveCoins()">Set</button>
                </div>
            </div>

            <div class="admin-section">
                <p style="font-size:11px; font-weight:800; color:var(--text-muted); margin-bottom:8px;">BADGES (TAP TO TOGGLE)</p>
                <div class="admin-badge-grid" id="adm-badge-grid"></div>
            </div>

            <button class="btn danger" style="margin-top:10px;" onclick="alert('Ban Logic Here')">üö´ Ban User</button>
            <button class="btn secondary" style="margin-top:10px;" onclick="closeModal('admin-modal')">Close</button>
        </div>
    </div>

    <div class="mobile-nav">
        <div class="mobile-tab active" onclick="switchNav('home-view')">üè†</div>
        <div class="mobile-tab" onclick="switchNav('family-view')">üë®‚Äçüë©‚Äçüëß</div>
        <div class="mobile-tab" onclick="switchNav('profile-view')">üë§</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc, getDoc, setDoc, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBoSEjCf3tECszYAUqed6hGntmL77JJ7Q",
            authDomain: "fambank-c839c.firebaseapp.com",
            projectId: "fambank-c839c",
            storageBucket: "fambank-c839c.firebasestorage.app",
            messagingSenderId: "875048284285",
            appId: "1:875048284285:web:0a1cf3c5f980015e210114"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMIN_EMAIL = "proeditdude@gmail.com";
        let currentUser, userData;
        let selectedAdminUid = null;
        let tempPfp = null, tempBan = null;

        // ORIGINAL BADGES LIST
        const BADGES = {
            'verified': 'https://cdn3.emoji.gg/emojis/70818-verified.png',
            'creator': 'https://cdn3.emoji.gg/emojis/927654-youtuberroleicon.png',
            'staff': 'https://cdn3.emoji.gg/emojis/679243-staff.png',
            'supporter': 'https://cdn3.emoji.gg/emojis/58236-booster.png',
            'bronze': 'https://cdn3.emoji.gg/emojis/94211-bronzerank.png',
            'silver': 'https://cdn3.emoji.gg/emojis/83657-silverrank.png',
            'gold': 'https://cdn3.emoji.gg/emojis/94211-goldrank.png',
            'platinum': 'https://cdn3.emoji.gg/emojis/85322-platinumrank.png',
            'diamond': 'https://cdn3.emoji.gg/emojis/85322-diamondrank.png',
            'onyx': 'https://cdn3.emoji.gg/emojis/25827-onyxrank.png',
            'nemesis': 'https://cdn3.emoji.gg/emojis/83657-nemisesrank.png'
        };

        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `<span>üîî</span> ${msg}`;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 3000);
        }

        // --- AUTH ---
        window.loginGoogle = () => signInWithPopup(auth, provider).catch(e=>toast(e.message));
        window.loginEmail = () => signInWithEmailAndPassword(auth, document.getElementById('email-in').value, document.getElementById('pass-in').value).catch(e=>toast(e.message));
        window.signupEmail = () => createUserWithEmailAndPassword(auth, document.getElementById('email-in').value, document.getElementById('pass-in').value).catch(e=>toast(e.message));
        window.logout = () => signOut(auth).then(()=>location.reload());

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                currentUser = u;
                const snap = await getDoc(doc(db, "users", u.uid));
                if(snap.exists()) {
                    userData = snap.data();
                    loadApp();
                } else {
                    document.getElementById('loader').style.display='none';
                    document.getElementById('auth-view').style.display='none';
                    document.getElementById('setup-view').style.display='block';
                    setTimeout(()=>document.getElementById('setup-view').classList.add('active'), 50);
                }
            } else {
                document.getElementById('loader').style.display='none';
                document.getElementById('auth-view').style.display='flex';
                setTimeout(()=>document.getElementById('auth-view').classList.add('active'), 50);
            }
        });

        window.finalizeSetup = async () => {
            const name = document.getElementById('setup-name').value;
            if(!name) return;
            const d = { name, email: currentUser.email, coins: 0, badges: [], pfp: 'üôÇ', banner: '' };
            await setDoc(doc(db,"users",currentUser.uid), d);
            location.reload();
        }

        // --- CORE ---
        function loadApp() {
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            document.getElementById('auth-view').style.display='none';
            document.getElementById('setup-view').style.display='none';
            document.getElementById('loader').style.display='none';
            switchNav('home-view');

            if(currentUser.email === ADMIN_EMAIL) {
                document.getElementById('admin-btn').style.display = 'flex';
                if(!userData.isAdmin) updateDoc(doc(db,"users",currentUser.uid), { isAdmin: true });
            }

            renderProfile();
            onSnapshot(doc(db, "users", currentUser.uid), (s) => {
                userData = s.data();
                renderProfile();
                document.getElementById('coin-count').innerText = userData.coins;
                if(userData.familyId) {
                    document.getElementById('fam-forms').style.display='none';
                    document.getElementById('fam-display').style.display='block';
                    getDoc(doc(db,"families",userData.familyId)).then(f=>{
                        if(f.exists()){
                            document.getElementById('d-fam-name').innerText = f.data().name;
                            document.getElementById('d-fam-code').innerText = f.data().inviteCode;
                        }
                    });
                }
            });
        }

        function renderProfile() {
            document.getElementById('p-name').innerText = userData.name;
            document.getElementById('p-email').innerText = userData.email;
            const p = document.getElementById('p-pfp');
            if(userData.pfp && userData.pfp.length > 5) {
                p.innerHTML = `<img src="${userData.pfp}">`;
                p.style.background = 'white';
            } else { p.innerHTML = userData.pfp || 'üôÇ'; p.style.background = '#F8F9FC'; }

            const b = document.getElementById('p-banner');
            if(userData.banner && userData.banner.length > 5) b.style.backgroundImage = `url(${userData.banner})`;
            else b.style.background = 'linear-gradient(135deg, #a8c0ff, #3f2b96)';

            const bg = document.getElementById('p-badges');
            bg.innerHTML = '';
            (userData.badges||[]).forEach(k => {
                if(BADGES[k]) bg.innerHTML += `<img src="${BADGES[k]}" class="badge-icon" title="${k}">`;
            });
        }

        // --- ADMIN ---
        window.openAdmin = async () => {
            if(currentUser.email !== ADMIN_EMAIL) return;
            switchNav('admin-view');
            const list = document.getElementById('admin-user-list');
            list.innerHTML = '<div style="text-align:center;color:#999;">Loading...</div>';
            const s = await getDocs(collection(db, "users"));
            list.innerHTML = '';
            s.forEach(d => {
                const u = d.data();
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => openAdminModal(d.id, u);
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="width:40px; height:40px; background:#eee; border-radius:50%; overflow:hidden;">
                            ${u.pfp && u.pfp.length > 5 ? `<img src="${u.pfp}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;">üôÇ</div>'}
                        </div>
                        <div>
                            <div style="font-weight:700;">${u.name}</div>
                            <div style="font-size:12px; color:#999;">${u.email}</div>
                        </div>
                    </div>
                    <div style="font-weight:800; color:var(--primary); background:#F0F4FF; padding:5px 10px; border-radius:10px;">${u.coins} T</div>
                `;
                list.appendChild(div);
            });
        }

        window.openAdminModal = (uid, u) => {
            selectedAdminUid = uid;
            document.getElementById('adm-title').innerText = u.name;
            document.getElementById('adm-name-in').value = u.name;
            document.getElementById('adm-coin-in').value = u.coins;
            renderAdminBadges(u.badges || []);
            openModal('admin-modal');
        }

        function renderAdminBadges(userBadges) {
            const grid = document.getElementById('adm-badge-grid');
            grid.innerHTML = '';
            Object.keys(BADGES).forEach(key => {
                const hasIt = userBadges.includes(key);
                const el = document.createElement('div');
                el.className = `admin-badge-item ${hasIt ? 'active' : ''}`;
                el.innerHTML = `<img src="${BADGES[key]}">`;
                el.onclick = () => toggleBadge(key, hasIt);
                grid.appendChild(el);
            });
        }

        window.toggleBadge = async (key, hasIt) => {
            if(!selectedAdminUid) return;
            const ref = doc(db, "users", selectedAdminUid);
            if(hasIt) await updateDoc(ref, { badges: arrayRemove(key) });
            else await updateDoc(ref, { badges: arrayUnion(key) });
            const snap = await getDoc(ref);
            renderAdminBadges(snap.data().badges || []);
        }

        window.adminSaveName = async () => {
            await updateDoc(doc(db,"users",selectedAdminUid), { name: document.getElementById('adm-name-in').value });
            toast("Name Saved");
        }
        window.adminSaveCoins = async () => {
            await updateDoc(doc(db,"users",selectedAdminUid), { coins: parseInt(document.getElementById('adm-coin-in').value) });
            toast("Coins Saved");
        }

        // --- UI UTILS ---
        window.switchNav = (id) => {
            document.querySelectorAll('.view').forEach(e => {
                e.classList.remove('active');
                if(e.id === id) {
                    e.style.display = 'block';
                    setTimeout(()=>e.classList.add('active'), 10);
                } else {
                    setTimeout(()=>e.style.display='none', 400);
                }
            });
            document.querySelectorAll('.mobile-tab').forEach(t=>t.classList.remove('active'));
            if(id==='home-view') document.querySelectorAll('.mobile-tab')[0].classList.add('active');
            if(id==='family-view') document.querySelectorAll('.mobile-tab')[1].classList.add('active');
            if(id==='profile-view') document.querySelectorAll('.mobile-tab')[2].classList.add('active');
        }

        window.openModal = (id) => {
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(()=>m.classList.add('show'), 10);
        }
        window.closeModal = (id) => {
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(()=>m.style.display='none', 300);
        }
        
        window.openEditProfile = () => {
            document.getElementById('edit-name-in').value = userData.name;
            openModal('edit-modal');
        }
        window.previewFile = (inId, prevId) => {
            const f = document.getElementById(inId).files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(prevId).style.backgroundImage = `url(${e.target.result})`;
                document.getElementById(prevId).style.display='block';
                if(inId==='file-pfp') tempPfp = e.target.result;
                if(inId==='file-ban') tempBan = e.target.result;
            };
            reader.readAsDataURL(f);
        }
        window.saveProfile = async () => {
            const u = { name: document.getElementById('edit-name-in').value };
            if(tempPfp) u.pfp = tempPfp;
            if(tempBan) u.banner = tempBan;
            await updateDoc(doc(db,"users",currentUser.uid), u);
            closeModal('edit-modal');
            toast("Profile Updated");
        }
        
        window.createFamily = async () => {
            const n = document.getElementById('fam-name-in').value;
            if(!n) return;
            const c = Math.floor(1000+Math.random()*9000).toString();
            const ref = await addDoc(collection(db,"families"), { name:n, inviteCode:c });
            await updateDoc(doc(db,"users",currentUser.uid), { familyId: ref.id });
        }
        window.joinFamily = async () => {
            const c = document.getElementById('fam-code-in').value;
            const q = query(collection(db,"families"), where("inviteCode","==",c));
            const s = await getDocs(q);
            if(!s.empty) {
                let fid; s.forEach(d=>fid=d.id);
                await updateDoc(doc(db,"users",currentUser.uid), { familyId: fid });
            } else toast("Invalid Code");
        }
    </script>
</body>
</html>
