<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F2F7"> <title>FamBank</title>
    <style>
        /* --- iOS DESIGN SYSTEM --- */
        :root {
            --ios-blue: #007AFF;
            --ios-bg: #F2F2F7;         /* System Gray 6 */
            --ios-card: #FFFFFF;       /* White */
            --ios-text: #000000;
            --ios-gray-text: #8E8E93;  /* System Gray */
            --ios-separator: #C6C6C8;  /* Separator Color */
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            color: var(--ios-text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- VIEWS --- */
        .view {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            padding-top: 60px; /* Header space */
            padding-bottom: calc(90px + var(--safe-bottom)); /* Tab bar space */
        }
        .view.active { display: block; }

        /* --- COMPONENTS --- */
        h1 { font-size: 34px; font-weight: 700; margin: 0 0 10px 0; letter-spacing: -0.5px; }
        h2 { font-size: 22px; font-weight: 600; margin: 20px 0 10px 0; }
        p { color: var(--ios-gray-text); font-size: 17px; margin: 0 0 20px 0; line-height: 1.4; }

        /* iOS List/Card Style */
        .ios-list {
            background: var(--ios-card);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .list-item {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-bottom: 0.5px solid var(--ios-separator);
            cursor: pointer;
            transition: background 0.2s;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:active { background: #E5E5EA; }
        
        .list-icon { font-size: 24px; width: 35px; text-align: center; margin-right: 15px; }
        .list-content { flex: 1; font-size: 17px; }
        .list-arrow { color: #C7C7CC; font-weight: 600; font-size: 18px; }

        /* Buttons */
        .btn-ios {
            background: var(--ios-blue);
            color: white;
            border: none;
            font-size: 17px;
            font-weight: 600;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            margin-top: 10px;
            cursor: pointer;
        }
        .btn-ios:active { opacity: 0.7; }
        .btn-text { background: none; color: var(--ios-blue); margin-top: 10px; }

        /* Inputs */
        input {
            width: 100%;
            padding: 16px;
            font-size: 17px;
            border: none;
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        /* --- TAB BAR (BOTTOM) --- */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(50px + var(--safe-bottom));
            background: rgba(249, 249, 249, 0.94); /* Translucent */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 500;
        }

        .tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--ios-gray-text);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
        }
        .tab-btn svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
        
        .tab-btn.active { color: var(--ios-blue); }

        /* --- "MORE" SHEET (MODAL) --- */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .sheet-overlay.open { opacity: 1; pointer-events: auto; }

        .action-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: var(--ios-bg);
            border-radius: 16px 16px 0 0;
            padding: 20px;
            padding-bottom: calc(40px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .sheet-overlay.open .action-sheet { transform: translateY(0); }
        
        .sheet-handle {
            width: 40px; height: 5px; background: #C7C7CC;
            border-radius: 10px; margin: 0 auto 20px auto;
        }

        /* Header Bar (Fake Navigation Bar) */
        .nav-bar {
            position: fixed; top: 0; left: 0; width: 100%;
            height: 44px; padding-top: env(safe-area-inset-top);
            display: flex; justify-content: center; align-items: center;
            background: rgba(242,242,247,0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            font-weight: 600; font-size: 17px;
        }

        /* --- ICONS (SVG) --- */
        .icon { width:24px; height:24px; display:block; }
    </style>
</head>
<body>

    <div class="nav-bar" id="nav-title">Family Centre</div>

    <div id="auth-view" class="view active" style="z-index: 2000; background: var(--ios-bg); padding-top: 100px;">
        <div style="text-align: center; margin-bottom: 40px;">
            <div style="font-size: 60px;">üè¶</div>
            <h1>FamBank</h1>
            <p>iOS Edition</p>
        </div>

        <div class="ios-list" style="margin: 0 20px;">
            <div class="list-item" style="display:block;">
                <input type="email" id="email-in" placeholder="Email" style="margin:0; padding:0;">
            </div>
            <div class="list-item" style="display:block; border:none;">
                <input type="password" id="pass-in" placeholder="Password" style="margin:0; padding:0;">
            </div>
        </div>

        <div style="padding: 0 20px;">
            <button class="btn-ios" onclick="loginEmail()">Log In</button>
            <button class="btn-ios btn-text" onclick="loginGoogle()">Sign in with Google</button>
            <button class="btn-ios btn-text" onclick="signupEmail()" style="color:var(--ios-gray-text);">Create Account</button>
        </div>
        <p id="auth-error" style="color:red; text-align:center; margin-top:20px;"></p>
    </div>

    <div id="home-view" class="view">
        <h1 style="margin-top: 20px;">Dashboard</h1>
        
        <div style="background: linear-gradient(135deg, #007AFF, #00C6FF); color: white; padding: 25px; border-radius: 18px; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(0,122,255,0.2);">
            <p style="color:rgba(255,255,255,0.8); margin:0; font-size:15px; font-weight:600; text-transform:uppercase;">Current Balance</p>
            <h1 style="font-size: 48px; margin: 5px 0;" id="coin-count">0</h1>
            <div style="font-size: 15px; opacity: 0.9;">Tokens Available</div>
        </div>

        <div id="no-family-state" style="display:none; text-align:center; padding: 20px;">
            <p>You aren't in a family group yet.</p>
            <button class="btn-ios btn-text" onclick="openMoreMenu()">Tap 'More' to Join</button>
        </div>

        <div id="family-content">
            <h2 style="padding-left: 5px;">Today's Tasks</h2>
            <div id="task-list" class="ios-list" style="background: transparent;">
                </div>
        </div>
    </div>

    <div id="profile-view" class="view">
        <h1 style="margin-top: 20px;">Profile</h1>
        
        <div class="ios-list">
            <div class="list-item">
                <div class="list-content">Name</div>
                <div style="color:var(--ios-gray-text);" id="display-name">...</div>
            </div>
            <div class="list-item">
                <div class="list-content">Role</div>
                <div style="color:var(--ios-gray-text);" id="user-role-badge">...</div>
            </div>
            <div class="list-item">
                <div class="list-content">Email</div>
                <div style="color:var(--ios-gray-text); font-size:14px;" id="user-email">...</div>
            </div>
        </div>

        <button class="btn-ios" style="background:white; color:#FF3B30;" onclick="logout()">Log Out</button>
    </div>

    <div class="sheet-overlay" id="more-sheet" onclick="closeMoreMenu(event)">
        <div class="action-sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <h2 style="margin-top:0;">More Options</h2>

            <div class="ios-list">
                <div class="list-item" onclick="alert('Store Feature coming soon!')">
                    <span class="list-icon">üõçÔ∏è</span>
                    <div class="list-content">Rewards Store</div>
                    <div class="list-arrow">‚Ä∫</div>
                </div>
            </div>

            <div class="ios-list">
                <div class="list-item" onclick="toggleFamilyForms()">
                    <span class="list-icon">üë®‚Äçüë©‚Äçüëß</span>
                    <div class="list-content">Create or Join Family</div>
                    <div class="list-arrow">‚Ä∫</div>
                </div>
                
                <div id="fam-forms" style="display:none; padding:16px; background:#f9f9f9; border-top: 1px solid #ccc;">
                    <input type="text" id="create-fam-name" placeholder="New Family Name">
                    <button class="btn-ios" style="margin-bottom:15px;" onclick="createFamily()">Create New</button>
                    <div style="text-align:center; margin:10px; color:#aaa;">- OR -</div>
                    <input type="number" id="join-fam-code" placeholder="Invite Code">
                    <button class="btn-ios" style="background:#8E8E93;" onclick="joinFamily()">Join Existing</button>
                </div>
            </div>
            
            <div id="more-fam-info" class="ios-list" style="display:none;">
                <div class="list-item">
                    <span class="list-icon">‚ÑπÔ∏è</span>
                    <div class="list-content">Invite Code: <span id="fam-code-display" style="font-weight:bold; color:var(--ios-blue);">Loading...</span></div>
                </div>
            </div>

            <button class="btn-ios" style="background: white; color: var(--ios-blue); margin-top:10px;" onclick="closeMoreMenu()">Cancel</button>
        </div>
    </div>

    <div class="tab-bar" id="tab-bar" style="display:none;">
        <div class="tab-btn active" id="tab-home" onclick="switchTab('home-view')">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            Home
        </div>

        <div class="tab-btn" id="tab-profile" onclick="switchTab('profile-view')">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            Profile
        </div>

        <div class="tab-btn" id="tab-more" onclick="openMoreMenu()">
            <svg viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            More
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBoSEjCf3tECszYAUqed6hGntmL77JJ7Q",
            authDomain: "fambank-c839c.firebaseapp.com",
            projectId: "fambank-c839c",
            storageBucket: "fambank-c839c.firebasestorage.app",
            messagingSenderId: "875048284285",
            appId: "1:875048284285:web:0a1cf3c5f980015e210114"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userData = null;

        // --- AUTH ---
        window.loginGoogle = () => signInWithPopup(auth, provider).catch(e => document.getElementById('auth-error').innerText = e.message);
        window.loginEmail = () => signInWithEmailAndPassword(auth, document.getElementById('email-in').value, document.getElementById('pass-in').value).catch(e => document.getElementById('auth-error').innerText = e.message);
        window.signupEmail = () => createUserWithEmailAndPassword(auth, document.getElementById('email-in').value, document.getElementById('pass-in').value).catch(e => document.getElementById('auth-error').innerText = e.message);
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Check user doc
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    userData = snap.data();
                    loadApp();
                } else {
                    // Quick setup for new user
                    const name = prompt("What is your name?");
                    if(name) {
                        await setDoc(doc(db, "users", user.uid), { name: name, email: user.email, coins: 0, familyId: null, role: null });
                        location.reload();
                    }
                }
            } else {
                document.getElementById('auth-view').classList.add('active');
                document.getElementById('tab-bar').style.display = 'none';
                document.getElementById('nav-title').innerText = "Login";
            }
        });

        // --- NAVIGATION ---
        window.switchTab = (viewId) => {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            // Show selected view
            document.getElementById(viewId).classList.add('active');
            
            // Update Tab Icons
            document.getElementById('tab-home').classList.remove('active');
            document.getElementById('tab-profile').classList.remove('active');
            
            if(viewId === 'home-view') {
                document.getElementById('tab-home').classList.add('active');
                document.getElementById('nav-title').innerText = "Family Centre";
            } else if (viewId === 'profile-view') {
                document.getElementById('tab-profile').classList.add('active');
                document.getElementById('nav-title').innerText = "Profile";
            }
        };

        // --- MORE MENU LOGIC ---
        window.openMoreMenu = () => {
            document.getElementById('more-sheet').classList.add('open');
            document.getElementById('tab-more').classList.add('active');
        };

        window.closeMoreMenu = (e) => {
            if (e && e.target !== document.getElementById('more-sheet') && e.target.tagName !== 'BUTTON') return;
            document.getElementById('more-sheet').classList.remove('open');
            document.getElementById('tab-more').classList.remove('active');
            
            // Re-highlight current tab
            if(document.getElementById('home-view').classList.contains('active')) document.getElementById('tab-home').classList.add('active');
            else document.getElementById('tab-profile').classList.add('active');
        };

        window.toggleFamilyForms = () => {
            const el = document.getElementById('fam-forms');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        };

        // --- DATA LOADING ---
        function loadApp() {
            document.getElementById('auth-view').classList.remove('active');
            document.getElementById('tab-bar').style.display = 'flex';
            
            // Fill Profile
            document.getElementById('display-name').innerText = userData.name;
            document.getElementById('user-email').innerText = currentUser.email;
            document.getElementById('user-role-badge').innerText = userData.role || "None";
            
            switchTab('home-view');

            // Listen for Coins
            onSnapshot(doc(db, "users", currentUser.uid), (d) => {
                document.getElementById('coin-count').innerText = d.data().coins || 0;
            });

            // Family Logic
            if(userData.familyId) {
                document.getElementById('no-family-state').style.display = 'none';
                document.getElementById('family-content').style.display = 'block';
                document.getElementById('more-fam-info').style.display = 'block';

                getDoc(doc(db, "families", userData.familyId)).then(s => {
                    if(s.exists()) document.getElementById('fam-code-display').innerText = s.data().inviteCode;
                });
                loadTasks();
            } else {
                document.getElementById('no-family-state').style.display = 'block';
                document.getElementById('family-content').style.display = 'none';
            }
        }

        // --- TASKS & FAMILY ---
        window.createFamily = async () => {
            const name = document.getElementById('create-fam-name').value;
            if(!name) return;
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            const ref = await addDoc(collection(db, "families"), { name, inviteCode: code, admin: currentUser.uid });
            await updateDoc(doc(db, "users", currentUser.uid), { familyId: ref.id, role: 'parent' });
            location.reload();
        };

        window.joinFamily = async () => {
            const code = document.getElementById('join-fam-code').value;
            const q = query(collection(db, "families"), where("inviteCode", "==", code));
            const snap = await getDocs(q);
            if(snap.empty) return alert("Code not found.");
            let fid = null; snap.forEach(d => fid = d.id);
            await updateDoc(doc(db, "users", currentUser.uid), { familyId: fid, role: 'child' });
            location.reload();
        };

        function loadTasks() {
            const q = query(collection(db, "tasks"), where("familyId", "==", userData.familyId));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('task-list');
                list.innerHTML = "";
                if(snap.empty) list.innerHTML = "<div style='padding:20px; text-align:center; color:#8E8E93;'>No tasks available</div>";
                
                snap.forEach(d => {
                    const t = d.data();
                    // iOS List Item Style
                    list.innerHTML += `
                        <div class="list-item" style="background:white; margin:0; border-radius:0;">
                            <div style="width:20px; height:20px; border:2px solid #C7C7CC; border-radius:50%; margin-right:15px; display:flex; justify-content:center; align-items:center;">
                                ${t.status === 'Done' ? '<div style="width:12px; height:12px; background:#007AFF; border-radius:50%;"></div>' : ''}
                            </div>
                            <div class="list-content">
                                <div style="font-weight:600;">${t.title}</div>
                                <div style="font-size:13px; color:var(--ios-gray-text);">Reward: ${t.reward} Tokens</div>
                            </div>
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>
